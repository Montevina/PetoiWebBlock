<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Petoi Web Coding Blocks</title>
  <!-- 1. 首先加载 Blockly 核心文件 -->
  <script src="./node_modules/blockly/blockly_compressed.js"></script>
  <script src="./node_modules/blockly/blocks_compressed.js"></script>
  <script src="./node_modules/blockly/javascript_compressed.js"></script>
  <!-- 2. 加载语言文件 -->
  <script src="./node_modules/blockly/msg/zh-hans.js"></script>
  <!-- 移除英文语言文件，使用动态加载 -->
  <!-- <script src="./node_modules/blockly/msg/en.js"></script> -->
  <!-- 3. 加载自定义翻译 -->
  <script src="./lang/translations.js"></script>
  <!-- 4. 然后加载自定义积木块文件 -->
  <script src="./blocks/communication.js"></script>
  <script src="./blocks/control.js"></script>
  <script src="./blocks/sensor.js"></script>
  <script src="./blocks/motion.js"></script>
  <script src="./blocks/generators.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }

    .language-switch {
      display: flex;
      gap: 10px;
    }

    .lang-btn {
      padding: 5px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .lang-btn.active {
      background-color: #007bff;
      color: #fff;
      border-color: #007bff;
    }

    .container {
      padding: 20px;
    }

    .button-group {
      margin-bottom: 20px;
    }

    .button-group button {
      padding: 8px 15px;
      margin-right: 10px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .button-group button:hover {
      background-color: #0056b3;
    }

    .workspace-container {
      display: flex;
      gap: 20px;
      height: calc(100vh - 150px);
      /* 使用视口高度计算容器高度 */
    }

    #blocklyDiv {
      width: 70%;
      height: 100%;
      /* 使用100%高度填充父容器 */
      border: 1px solid #ccc;
    }

    .windows-container {
      width: 30%;
      height: 100%;
      /* 使用100%高度填充父容器 */
      display: flex;
      flex-direction: column;
    }

    #consoleWindow {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #1e1e1e;
      padding: 10px;
      font-family: 'Consolas', monospace;
      overflow-y: auto;
    }

    /* 修复积木块文字偏移问题 */
    .blocklyText {
      fill: #fff;
      font-family: sans-serif;
      font-size: 11pt;
      font-weight: normal;
    }

    .blocklyNonEditableText>text,
    .blocklyEditableText>text {
      fill: #000;
    }

    .blocklyDropdownText {
      fill: #000 !important;
    }

    #loadInput {
      display: none;
    }

    .console-item {
      padding: 3px 5px;
      margin-bottom: 2px;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
      color: #ffffff;
    }

    /* 串口通信相关样式 */
    #serialContainer {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
    }

    .serial-button {
      padding: 6px 12px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    .serial-output {
      height: 200px;
      border: 1px solid #ccc;
      margin: 10px 0;
      padding: 10px;
      overflow-y: auto;
      background-color: #1e1e1e;
      color: #fff;
      font-family: 'Consolas', monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-all;
      line-height: 1;
      font-size: 13px;
    }

    .serial-output br {
      line-height: 1;
      margin: 0;
      padding: 0;
    }

    .serial-input-container {
      display: flex;
      gap: 5px;
    }

    .serial-input-container input {
      flex: 1;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .serial-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .serial-button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .wifi-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .wifi-dialog input {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .wifi-dialog .button-container {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    .wifi-dialog button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .wifi-dialog button.confirm {
      background-color: #007bff;
      color: white;
    }

    .wifi-dialog button.cancel {
      background-color: #6c757d;
      color: white;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .blocklyZoom>image,
    .blocklyZoom>svg>image {
      opacity: 0.4;
    }

    .blocklyZoom>image:hover,
    .blocklyZoom>svg>image:hover {
      opacity: 0.6;
    }

    .blocklyZoom>image:active,
    .blocklyZoom>svg>image:active {
      opacity: 0.8;
    }

    /* 撤销重做按钮样式 */
    .undoRedoControls {
      position: fixed;
      z-index: 1000;
      overflow: visible;
      display: flex;
      flex-direction: column;
      border-radius: 4px;
    }

    .undoRedoButton {
      background-color: #fff;
      border: 1px solid #ddd;
      width: 31px;
      height: 31px;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .undoRedoButton img,
    .undoRedoButton svg {
      width: 18px;
      height: 18px;
      opacity: 0.4;
    }

    .undoRedoButton:hover {
      background-color: #f1f1f1;
    }

    .undoRedoButton:hover img,
    .undoRedoButton:hover svg {
      opacity: 0.6;
    }

    .undoRedoButton:active {
      background-color: #e0e0e0;
    }

    .undoRedoButton:active img,
    .undoRedoButton:active svg {
      opacity: 0.8;
    }

    .undoRedoButton[disabled] {
      cursor: default;
      background-color: #f8f8f8;
    }

    .undoRedoButton[disabled] img,
    .undoRedoButton[disabled] svg {
      opacity: 0.2;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="title">Petoi Web Coding Blocks</div>
    <div class="language-switch">
      <button id="zhBtn" class="lang-btn" onclick="setLanguage('zh')">中文</button>
      <button id="enBtn" class="lang-btn active" onclick="setLanguage('en')">English</button>
    </div>
  </div>
  <div class="container">
    <div class="button-group">
      <button onclick="showCode()">Show Code</button>
      <button onclick="runCode()">Run Code</button>
      <button onclick="saveWorkspace()">Save Program</button>
      <button onclick="document.getElementById('loadInput').click()">Load Program</button>
      <button onclick="clearWorkspace()">Clear All</button>
      <input type="file" id="loadInput" accept=".json" onchange="loadWorkspace(this.files[0])">
      <span id="currentFileName" style="margin-left: 10px; color: #555; font-style: italic;"></span>
      <span id="ipDisplay" style="margin-left: 10px; color: #007bff;"></span>
    </div>

    <div class="workspace-container">
      <div id="blocklyDiv"></div>
      <div class="windows-container">
        <div id="consoleWindow">
          <div style="margin-bottom: 10px;">
            <span style="font-weight: bold; color: #fff;">Console Log</span>
            <button onclick="clearConsole()" style="float: right; padding: 4px 8px; cursor: pointer;">
              Clear Log
            </button>
          </div>
          <div id="consoleLog"></div>
        </div>
        <!-- 添加串口通信相关的HTML结构 -->
        <div id="serialContainer" style="margin-top: 20px;">
          <div class="serial-buttons">
            <button onclick="openSerialPort()" class="serial-button">Connect Serial Port</button>
            <button onclick="quickConnect()" class="serial-button" id="quickConnectBtn" disabled>Quick Connect</button>
            <button onclick="closeSerialPort()" class="serial-button" id="closeSerialBtn" disabled>Close
              Connection</button>
          </div>
          <div id="serialInterface" style="display: none;">
            <div class="serial-output" id="serialOutput"></div>
            <div class="serial-input-container">
              <input type="text" id="serialInput" placeholder="Enter content to send">
              <button onclick="sendSerialData()" class="serial-button">Send</button>
              <button onclick="clearSerialOutput()" class="serial-button">Clear Display</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 自定义主题
    const customTheme = Blockly.Theme.defineTheme('myCustomTheme', {
      'base': Blockly.Themes.Classic, // 继承经典主题的基础配置
      'categoryStyles': {
        'communication_category': {
          'colour': '#E63946', // 红色
        },
        'motion_category': {
          'colour': '#4361EE', // 蓝色
        },
        'control_category': {
          'colour': '#06D6A0', // 绿色
        },
        'sensor_category': {
          'colour': '#FFB703', // 黄色
        },
        'console_category': {
          'colour': '#9C27B0', // 紫色
        }
      }
    });

    var toolbox = {
      kind: 'categoryToolbox',
      contents: [
        {
          kind: 'category',
          name: 'Logic',
          categorystyle: 'logic_category',
          contents: [
            { kind: 'block', type: 'controls_if' },
            { kind: 'block', type: 'logic_compare' },
            { kind: 'block', type: 'logic_operation' },
            { kind: 'block', type: 'logic_negate' },
            { kind: 'block', type: 'logic_boolean' },
            { kind: 'block', type: 'logic_null' },
            { kind: 'block', type: 'logic_ternary' }
          ]
        },
        {
          kind: 'category',
          name: 'Loops',
          categorystyle: 'loop_category',
          contents: [
            { kind: 'block', type: 'controls_repeat_ext' },
            { kind: 'block', type: 'controls_whileUntil' },
            { kind: 'block', type: 'controls_for' },
            { kind: 'block', type: 'controls_forEach' },
            { kind: 'block', type: 'controls_flow_statements' }
          ]
        },
        {
          kind: 'category',
          name: 'Math',
          categorystyle: 'math_category',
          contents: [
            { kind: 'block', type: 'math_number' },
            { kind: 'block', type: 'math_arithmetic' },
            { kind: 'block', type: 'math_single' },
            { kind: 'block', type: 'math_trig' },
            { kind: 'block', type: 'math_constant' },
            { kind: 'block', type: 'math_number_property' },
            { kind: 'block', type: 'math_round' },
            { kind: 'block', type: 'math_modulo' }
          ]
        },
        {
          kind: 'category',
          name: 'Text',
          categorystyle: 'text_category',
          contents: [
            { kind: 'block', type: 'text' },
            { kind: 'block', type: 'text_join' },
            { kind: 'block', type: 'text_append' },
            { kind: 'block', type: 'text_length' },
            { kind: 'block', type: 'text_isEmpty' },
            { kind: 'block', type: 'text_indexOf' },
            { kind: 'block', type: 'text_charAt' },
            { kind: 'block', type: 'text_getSubstring' },
            { kind: 'block', type: 'text_changeCase' },
            { kind: 'block', type: 'text_trim' },
            { kind: 'block', type: 'text_print' }
          ]
        },
        {
          kind: 'category',
          name: 'Variables',
          categorystyle: 'variable_category',
          custom: 'VARIABLE'
        },
        {
          kind: 'category',
          name: 'Functions',
          categorystyle: 'procedure_category',
          custom: 'PROCEDURE'
        },
        {
          kind: 'category',
          name: 'Communication',
          categorystyle: 'communication_category',
          contents: [
            { kind: 'block', type: 'make_connection' },
            { kind: 'block', type: 'get_digital_input' },
            { kind: 'block', type: 'get_analog_input' },
            { kind: 'block', type: 'set_digital_output' },
            { kind: 'block', type: 'set_analog_output' },
            { kind: 'block', type: 'send_custom_command' }
          ]
        },
        {
          kind: 'category',
          name: 'Motion',
          categorystyle: 'motion_category',
          contents: [
            { kind: 'block', type: 'direction_action' },
            { kind: 'block', type: 'local_action' },
            { kind: 'block', type: 'high_difficulty_action' },
            { kind: 'block', type: 'set_motor_angle' },
            { kind: 'block', type: 'get_joint_angle' },
            { kind: 'block', type: 'get_all_joint_angles' }
          ]
        },
        {
          kind: 'category',
          name: 'Control',
          categorystyle: 'control_category',
          contents: [
            { kind: 'block', type: 'delay_ms' }
          ]
        },
        {
          kind: 'category',
          name: 'Sensors',
          categorystyle: 'sensor_category',
          contents: [
            { kind: 'block', type: 'gyro_control' },
            { kind: 'block', type: 'get_sensor_input' }
          ]
        },
        {
          kind: 'category',
          name: 'Console',
          categorystyle: 'console_category',
          contents: [
            { kind: 'block', type: 'console_log_variable' }
          ]
        }
      ]
    };

    var workspace = Blockly.inject('blocklyDiv', {
      media: './node_modules/blockly/media/',
      toolbox: toolbox,
      theme: customTheme,
      grid: {
        spacing: 20,
        length: 3,
        colour: '#ccc',
        snap: true
      },
      zoom: {
        controls: true,
        wheel: true,
        startScale: 1.0,
        maxScale: 3,
        minScale: 0.3,
        scaleSpeed: 1.2
      },
      trashcan: true
    });

    // 添加开始积木块
    var startBlocks = {

    };

    // 保存原始的工具箱配置（英文）
    const originalToolboxContents = JSON.parse(JSON.stringify(toolbox.contents));

    // 保存不同语言的消息对象
    const zhMessages = {};
    const enMessages = {};

    // 当前语言
    let isChangingLanguage = false;

    // 新增翻译助手函数
    function getText(key)
    {
      return TRANSLATIONS[currentLang][key] || key;
    }

    // 更新自定义积木的定义
    function updateCustomBlockDefinitions()
    {
      // 更新所有工作区中的积木
      if (workspace)
      {
        // 使用根块优先的方式处理
        // 1. 首先找出所有没有父块的根积木
        const rootBlocks = workspace.getTopBlocks(true);

        // 2. 递归处理每个根积木及其子积木
        rootBlocks.forEach(rootBlock =>
        {
          updateBlockAndChildren(rootBlock);
        });
      }

      // 定义递归更新块和其子块的函数
      function updateBlockAndChildren(block)
      {
        if (block.type === 'make_connection' ||
          block.type === 'get_digital_input' ||
          block.type === 'get_analog_input' ||
          block.type === 'get_sensor_input' ||
          block.type === 'set_digital_output' ||
          block.type === 'set_analog_output' ||
          block.type === 'send_custom_command' ||
          block.type === 'delay_ms' ||
          block.type === 'local_action' ||
          block.type === 'direction_action' ||
          block.type === 'high_difficulty_action' ||
          block.type === 'set_motor_angle' ||
          block.type === 'get_joint_angle' ||
          block.type === 'get_all_joint_angles' ||
          block.type === 'gyro_control' ||
          block.type === 'console_log_variable')
        {
          // 保存原有字段值
          const fieldValues = {};
          for (let i = 0; i < block.inputList.length; i++)
          {
            const input = block.inputList[i];
            for (let j = 0; j < input.fieldRow.length; j++)
            {
              const field = input.fieldRow[j];
              if (field.name)
              {
                fieldValues[field.name] = field.getValue();
              }
            }
          }

          // 保存位置信息
          const position = block.getRelativeToSurfaceXY();

          // 保存连接信息 - 包括所有输入连接
          const savedConnections = [];

          // 保存下一个块的连接
          if (block.nextConnection && block.nextConnection.isConnected())
          {
            savedConnections.push({
              type: 'next',
              connection: block.nextConnection.targetConnection
            });
          }

          // 保存所有输入连接
          for (let i = 0; i < block.inputList.length; i++)
          {
            const input = block.inputList[i];
            if (input.connection && input.connection.isConnected())
            {
              savedConnections.push({
                type: 'input',
                name: input.name,
                connection: input.connection.targetConnection
              });
            }
          }

          // 清空输入列表，避免积木元素堆叠
          block.inputList = [];

          // 重新初始化积木
          const initFunc = Blockly.Blocks[block.type].init;
          if (initFunc)
          {
            initFunc.call(block);

            // 恢复字段值
            for (const name in fieldValues)
            {
              const field = block.getField(name);
              if (field)
              {
                field.setValue(fieldValues[name]);
              }
            }

            // 恢复位置 - 只对根块有效
            if (!block.getParent())
            {
              const newPosition = block.getRelativeToSurfaceXY();
              block.moveBy(position.x - newPosition.x, position.y - newPosition.y);
            }

            // 重新渲染以确保视觉正确
            block.initSvg();
            block.render();
          }

          // 延迟恢复连接，确保所有块都已更新
          setTimeout(() =>
          {
            // 恢复所有保存的连接
            savedConnections.forEach(savedConn =>
            {
              if (savedConn.type === 'next')
              {
                if (block.nextConnection && savedConn.connection)
                {
                  block.nextConnection.connect(savedConn.connection);
                }
              } else if (savedConn.type === 'input')
              {
                const input = block.getInput(savedConn.name);
                if (input && input.connection && savedConn.connection)
                {
                  input.connection.connect(savedConn.connection);
                }
              }
            });
          }, 0);
        }

        // 递归处理所有子块
        if (block.nextConnection && block.nextConnection.targetBlock())
        {
          updateBlockAndChildren(block.nextConnection.targetBlock());
        }

        // 处理所有输入连接的子块
        for (let i = 0; i < block.inputList.length; i++)
        {
          const input = block.inputList[i];
          if (input.connection && input.connection.targetBlock())
          {
            updateBlockAndChildren(input.connection.targetBlock());
          }
        }
      }

      // 通信积木
      if (Blockly.Blocks['make_connection'])
      {
        Blockly.Blocks['make_connection'].init = function ()
        {
          this.jsonInit({
            "type": "make_connection",
            "message0": getText("connectWithIP"),
            "args0": [
              {
                "type": "field_input",
                "name": "IP_ADDRESS",
                "text": "x.x.x.x"
              }
            ],
            "nextStatement": null,
            "colour": '#E63946', // 通信积木：红色
            "tooltip": "",
            "helpUrl": ""
          });
        };
      }

      // 数字输入积木
      if (Blockly.Blocks['get_digital_input'])
      {
        Blockly.Blocks['get_digital_input'].init = function ()
        {
          this.jsonInit({
            "type": "get_digital_input",
            "message0": getText("getDigitalInput"),
            "args0": [
              {
                "type": "field_dropdown",
                "name": "PIN",
                "options": [
                  ["34", "34"],
                  ["35", "35"],
                  ["36", "36"],
                  ["39", "39"],
                  ["BackTouch(38)", "38"],
                  ["Rx2(9)", "9"],
                  ["Tx2(10)", "10"]
                ]
              }
            ],
            "output": true,
            "outputType": "Number",
            "colour": '#E63946', // 通信积木：红色
            "tooltip": ""
          });
        };
      }

      // 模拟输入积木
      if (Blockly.Blocks['get_analog_input'])
      {
        Blockly.Blocks['get_analog_input'].init = function ()
        {
          this.jsonInit({
            "type": "get_analog_input",
            "message0": getText("getAnalogInput"),
            "args0": [
              {
                "type": "field_dropdown",
                "name": "PIN",
                "options": [
                  ["34", "34"],
                  ["35", "35"],
                  ["36", "36"],
                  ["39", "39"],
                  ["BackTouch(38)", "38"],
                  ["Rx2(9)", "9"],
                  ["Tx2(10)", "10"]
                ]
              }
            ],
            "output": true,
            "outputType": "Number",
            "colour": '#E63946', // 通信积木：红色
            "tooltip": ""
          });
        };
      }

      // 传感器输入积木
      if (Blockly.Blocks['get_sensor_input'])
      {
        Blockly.Blocks['get_sensor_input'].init = function ()
        {
          this.jsonInit({
            "type": "get_sensor_input",
            "message0": getText("getSensorInput"),
            "args0": [
              {
                "type": "field_dropdown",
                "name": "SENSOR",
                "options": [
                  [getText("ultrasonic"), "ultrasonic"],
                  [getText("touch"), "touch"],
                  [getText("distance"), "distance"],
                  [getText("light"), "light"],
                  [getText("temperature"), "temperature"],
                  [getText("humidity"), "humidity"]
                ]
              }
            ],
            "output": true,
            "outputType": "Number",
            "colour": '#FFB703', // 传感器积木：黄色
            "tooltip": ""
          });
        };
      }

      // 数字输出积木
      if (Blockly.Blocks['set_digital_output'])
      {
        Blockly.Blocks['set_digital_output'].init = function ()
        {
          this.jsonInit({
            "type": "set_digital_output",
            "message0": getText("setDigitalOutput"),
            "args0": [
              {
                "type": "field_dropdown",
                "name": "PIN",
                "options": [
                  ["25", "25"],
                  ["26", "26"],
                  ["27", "27"],
                  ["14", "14"],
                  ["12", "12"],
                  ["13", "13"]
                ]
              },
              {
                "type": "field_dropdown",
                "name": "STATE",
                "options": [
                  ["HIGH", "1"],
                  ["LOW", "0"]
                ]
              }
            ],
            "previousStatement": null,
            "nextStatement": null,
            "colour": '#E63946', // 通信积木：红色
            "tooltip": ""
          });
        };
      }

      // 模拟输出积木
      if (Blockly.Blocks['set_analog_output'])
      {
        Blockly.Blocks['set_analog_output'].init = function ()
        {
          this.jsonInit({
            "type": "set_analog_output",
            "message0": getText("setAnalogOutput"),
            "args0": [
              {
                "type": "field_dropdown",
                "name": "PIN",
                "options": [
                  ["25", "25"],
                  ["26", "26"]
                ]
              },
              {
                "type": "field_number",
                "name": "VALUE",
                "value": 128,
                "min": 0,
                "max": 255
              }
            ],
            "previousStatement": null,
            "nextStatement": null,
            "colour": '#E63946', // 通信积木：红色
            "tooltip": ""
          });
        };
      }

      // 自定义命令积木
      if (Blockly.Blocks['send_custom_command'])
      {
        Blockly.Blocks['send_custom_command'].init = function ()
        {
          this.jsonInit({
            "type": "send_custom_command",
            "message0": getText("sendCustomCommand"),
            "args0": [
              {
                "type": "field_input",
                "name": "COMMAND",
                "text": ""
              }
            ],
            "previousStatement": null,
            "nextStatement": null,
            "colour": '#E63946', // 通信积木：红色
            "tooltip": ""
          });
        };
      }

      // 方向动作积木
      if (Blockly.Blocks['direction_action'])
      {
        Blockly.Blocks['direction_action'].init = function ()
        {
          this.jsonInit({
            "type": "direction_action",
            "message0": getText("directionAction"),
            "args0": [
              {
                "type": "field_dropdown",
                "name": "COMMAND",
                "options": [
                  [getText("forward"), "kwkF"],
                  [getText("backward"), "kbkF"],
                  [getText("left"), "kvtL"],
                  [getText("right"), "kvtR"],
                  [getText("leftForward"), "klf"],
                  [getText("leftBackward"), "klb"],
                  [getText("rightForward"), "krf"],
                  [getText("rightBackward"), "krb"],
                  [getText("stop"), "kstop"]
                ]
              }
            ],
            "previousStatement": null,
            "nextStatement": null,
            "colour": '#4361EE', // 动作积木：蓝色
            "tooltip": ""
          });
        };
      }

      // 本地动作积木
      if (Blockly.Blocks['local_action'])
      {
        Blockly.Blocks['local_action'].init = function ()
        {
          this.jsonInit({
            "type": "local_action",
            "message0": getText("localAction"),
            "args0": [
              {
                "type": "field_dropdown",
                "name": "COMMAND",
                "options": [
                  [getText("stand"), "kup"],
                  [getText("sit"), "ksit"],
                  [getText("rest"), "d"],
                  [getText("pee"), "kpee"]
                ]
              }
            ],
            "previousStatement": null,
            "nextStatement": null,
            "colour": '#4361EE', // 动作积木：蓝色
            "tooltip": ""
          });
        };
      }

      // 高难度动作积木
      if (Blockly.Blocks['high_difficulty_action'])
      {
        Blockly.Blocks['high_difficulty_action'].init = function ()
        {
          this.jsonInit({
            "type": "high_difficulty_action",
            "message0": getText("highDifficultyAction"),
            "args0": [
              {
                "type": "field_dropdown",
                "name": "COMMAND",
                "options": [
                  [getText("jump"), "kjmp"],
                  [getText("backflip"), "kbkF"],
                  [getText("roll"), "kroll"],
                  [getText("rotate"), "krot"]
                ]
              }
            ],
            "previousStatement": null,
            "nextStatement": null,
            "colour": '#4361EE', // 动作积木：蓝色
            "tooltip": ""
          });
        };
      }

      // 设置马达角度积木
      if (Blockly.Blocks['set_motor_angle'])
      {
        Blockly.Blocks['set_motor_angle'].init = function ()
        {
          this.jsonInit({
            "type": "set_motor_angle",
            "message0": getText("setMotorAngle"),
            "args0": [
              {
                "type": "field_dropdown",
                "name": "MOTOR",
                "options": [
                  ["0", "0"],
                  ["1", "1"],
                  ["2", "2"],
                  ["3", "3"],
                  ["4", "4"],
                  ["5", "5"],
                  ["6", "6"],
                  ["7", "7"],
                  ["8", "8"],
                  ["9", "9"],
                  ["10", "10"],
                  ["11", "11"]
                ]
              },
              {
                "type": "field_number",
                "name": "ANGLE",
                "value": 0,
                "min": -125,
                "max": 125
              }
            ],
            "previousStatement": null,
            "nextStatement": null,
            "colour": '#4361EE', // 动作积木：蓝色
            "tooltip": ""
          });
        };
      }

      // 获取舵机角度积木
      if (Blockly.Blocks['get_joint_angle'])
      {
        Blockly.Blocks['get_joint_angle'].init = function ()
        {
          this.jsonInit({
            "type": "get_joint_angle",
            "message0": getText("getJointAngle"),
            "args0": [
              {
                "type": "field_dropdown",
                "name": "JOINT",
                "options": [
                  ["0", "0"],
                  ["1", "1"],
                  ["2", "2"],
                  ["3", "3"],
                  ["4", "4"],
                  ["5", "5"],
                  ["6", "6"],
                  ["7", "7"],
                  ["8", "8"],
                  ["9", "9"],
                  ["10", "10"],
                  ["11", "11"]
                ]
              }
            ],
            "output": true,
            "outputType": "Number",
            "colour": '#4361EE', // 动作积木：蓝色
            "tooltip": ""
          });
        };
      }

      // 获取所有舵机角度积木
      if (Blockly.Blocks['get_all_joint_angles'])
      {
        Blockly.Blocks['get_all_joint_angles'].init = function ()
        {
          this.jsonInit({
            "type": "get_all_joint_angles",
            "message0": getText("getAllJointAngles"),
            "output": true,
            "outputType": "Array",
            "colour": '#4361EE', // 动作积木：蓝色
            "tooltip": ""
          });
        };
      }

      // 延时积木
      if (Blockly.Blocks['delay_ms'])
      {
        Blockly.Blocks['delay_ms'].init = function ()
        {
          this.jsonInit({
            "type": "delay_ms",
            "message0": getText("delayMs"),
            "args0": [
              {
                "type": "field_number",
                "name": "DELAY",
                "value": 1000,
                "min": 0
              }
            ],
            "previousStatement": null,
            "nextStatement": null,
            "colour": '#06D6A0', // 控制积木：绿色
            "tooltip": ""
          });
        };
      }

      // 陀螺仪控制积木
      if (Blockly.Blocks['gyro_control'])
      {
        Blockly.Blocks['gyro_control'].init = function ()
        {
          this.jsonInit({
            "type": "gyro_control",
            "message0": getText("gyroControl"),
            "args0": [
              {
                "type": "field_dropdown",
                "name": "STATE",
                "options": [
                  [getText("gyroEnable"), "1"],
                  [getText("gyroDisable"), "0"]
                ]
              }
            ],
            "previousStatement": null,
            "nextStatement": null,
            "colour": '#FFB703', // 传感器积木：黄色
            "tooltip": ""
          });
        };
      }

      // 控制台输出积木
      if (Blockly.Blocks['console_log_variable'])
      {
        Blockly.Blocks['console_log_variable'].init = function ()
        {
          this.jsonInit({
            "type": "console_log_variable",
            "message0": getText("consoleLogVariable"),
            "args0": [
              {
                "type": "input_value",
                "name": "VARIABLE"
              }
            ],
            "previousStatement": null,
            "nextStatement": null,
            "colour": '#9C27B0', // 控制台积木：紫色
            "tooltip": ""
          });
        };
      }
    }

    // 保存当前工作区的积木
    function saveCurrentWorkspace()
    {
      return Blockly.serialization.workspaces.save(workspace);
    }

    // 恢复工作区积木
    function restoreWorkspace(state)
    {
      Blockly.serialization.workspaces.load(state, workspace);
    }

    // 切换语言
    function setLanguage(lang)
    {
      if (isChangingLanguage || currentLang === lang) return;
      isChangingLanguage = true;

      // 更新按钮状态
      document.getElementById('zhBtn').classList.toggle('active', lang === 'zh');
      document.getElementById('enBtn').classList.toggle('active', lang === 'en');

      // 保存当前工作区状态
      const workspaceState = saveCurrentWorkspace();

      // 创建新的脚本元素
      const script = document.createElement('script');
      script.onload = function ()
      {
        // 设置当前语言
        currentLang = lang;

        // 更新自定义积木的定义
        updateCustomBlockDefinitions();

        // 创建新的工具箱配置并更新类别名称
        const categoryMap = {
          zh: {
            'Logic': '逻辑',
            'Loops': '循环',
            'Math': '数学',
            'Text': '文本',
            'Variables': '变量',
            'Functions': '函数',
            'Communication': '通信',
            'Motion': '动作',
            'Control': '控制',
            'Sensors': '传感器',
            'Console': '控制台'
          },
          en: {
            '逻辑': 'Logic',
            '循环': 'Loops',
            '数学': 'Math',
            '文本': 'Text',
            'Text': 'Text',
            '变量': 'Variables',
            '函数': 'Functions',
            '通信': 'Communication',
            '动作': 'Motion',
            '控制': 'Control',
            '传感器': 'Sensors',
            '控制台': 'Console'
          }
        };

        // 复制原始工具箱并翻译类别名称
        const newToolbox = JSON.parse(JSON.stringify(toolbox));
        for (let i = 0; i < newToolbox.contents.length; i++)
        {
          const category = newToolbox.contents[i];
          if (category.name)
          {
            const translatedName = categoryMap[lang][category.name];
            if (translatedName)
            {
              category.name = translatedName;
            }
          }
        }

        // 重新注入工作区
        workspace.dispose();
        workspace = Blockly.inject('blocklyDiv', {
          media: './node_modules/blockly/media/',
          toolbox: newToolbox,
          theme: customTheme,
          grid: {
            spacing: 20,
            length: 3,
            colour: '#ccc',
            snap: true
          },
          zoom: {
            controls: true,
            wheel: true,
            startScale: 1.0,
            maxScale: 3,
            minScale: 0.3,
            scaleSpeed: 1.2
          },
          trashcan: true
        });

        // 恢复工作区状态
        restoreWorkspace(workspaceState);

        // 再次更新自定义积木
        updateCustomBlockDefinitions();

        // 更新撤销和重做按钮状态
        updateUndoRedoState();

        // 更新IP显示文本
        const ipDisplay = document.getElementById('ipDisplay');
        if (ipDisplay && ipDisplay.textContent.trim() !== '')
        {
          // 从当前文本中提取IP地址
          const ipMatch = ipDisplay.textContent.match(/[0-9.]+$/);
          if (ipMatch)
          {
            const ip = ipMatch[0];
            ipDisplay.textContent = `${getText("serialConfiguredIP")}${ip}`;
          }
        }

        // 更新UI文本
        if (lang === 'zh')
        {
          // 主界面文本
          document.querySelector('.title').textContent = '陪拓网页编程积木';
          document.querySelector('button[onclick="showCode()"]').textContent = '显示代码';
          document.querySelector('button[onclick="runCode()"]').textContent = '运行代码';
          document.querySelector('button[onclick="saveWorkspace()"]').textContent = '保存程序';
          document.querySelector('button[onclick="document.getElementById(\'loadInput\').click()"]').textContent = '载入程序';
          document.querySelector('button[onclick="clearWorkspace()"]').textContent = '清空全部';
          document.querySelector('button[onclick="clearConsole()"]').textContent = '清除日志';

          // 更新当前文件名显示
          if (currentFile)
          {
            document.getElementById('currentFileName').textContent = `当前文件: ${currentFile.name}`;
          }

          // 串口连接界面文本
          document.querySelector('button[onclick="openSerialPort()"]').textContent = '使用串口有线连接';
          document.querySelector('button[onclick="quickConnect()"]').textContent = '快速联网';
          document.querySelector('button[onclick="closeSerialPort()"]').textContent = '关闭串口连接';
          document.querySelector('#serialInput').placeholder = '输入要发送的内容';
          document.querySelector('button[onclick="sendSerialData()"]').textContent = '发送';
          document.querySelector('button[onclick="clearSerialOutput()"]').textContent = '清空显示';

          // 控制台标题
          const consoleTitle = document.querySelector('#consoleWindow span');
          if (consoleTitle) consoleTitle.textContent = '控制台日志';
        } else
        {
          // 主界面文本
          document.querySelector('.title').textContent = 'Petoi Web Coding Blocks';
          document.querySelector('button[onclick="showCode()"]').textContent = 'Show Code';
          document.querySelector('button[onclick="runCode()"]').textContent = 'Run Code';
          document.querySelector('button[onclick="saveWorkspace()"]').textContent = 'Save Program';
          document.querySelector('button[onclick="document.getElementById(\'loadInput\').click()"]').textContent = 'Load Program';
          document.querySelector('button[onclick="clearWorkspace()"]').textContent = 'Clear All';
          document.querySelector('button[onclick="clearConsole()"]').textContent = 'Clear Log';

          // 更新当前文件名显示
          if (currentFile)
          {
            document.getElementById('currentFileName').textContent = `Current file: ${currentFile.name}`;
          }

          // 串口连接界面文本
          document.querySelector('button[onclick="openSerialPort()"]').textContent = 'Connect Serial Port';
          document.querySelector('button[onclick="quickConnect()"]').textContent = 'Quick Connect';
          document.querySelector('button[onclick="closeSerialPort()"]').textContent = 'Close Connection';
          document.querySelector('#serialInput').placeholder = 'Enter content to send';
          document.querySelector('button[onclick="sendSerialData()"]').textContent = 'Send';
          document.querySelector('button[onclick="clearSerialOutput()"]').textContent = 'Clear Display';

          // 控制台标题
          const consoleTitle = document.querySelector('#consoleWindow span');
          if (consoleTitle) consoleTitle.textContent = 'Console Log';
        }

        isChangingLanguage = false;
      };

      // 加载相应语言文件
      if (lang === 'zh')
      {
        script.src = './node_modules/blockly/msg/zh-hans.js';
      } else
      {
        script.src = './node_modules/blockly/msg/en.js';
      }

      // 移除可能存在的旧语言脚本
      const prevScript = document.querySelector('script[data-language-script]');
      if (prevScript)
      {
        prevScript.remove();
      }

      // 标记并添加新脚本
      script.setAttribute('data-language-script', 'true');
      document.head.appendChild(script);
    }

    // 初始化时设置默认语言为英文
    window.addEventListener('DOMContentLoaded', function ()
    {
      // 初始化默认语言为英文
      setLanguage('en');

      // 初始化自定义积木
      updateCustomBlockDefinitions();

      // 添加窗口大小变化事件监听器
      window.addEventListener('resize', resizeBlocklyWorkspace);

      // 初始调整工作区大小
      resizeBlocklyWorkspace();

      // 添加默认的connect with IP积木块
      addDefaultConnectionBlock();

      // 监听工作区变化事件
      workspace.addChangeListener(function (event)
      {
        // 当工作区被清空时，添加默认积木块
        if (event.type === Blockly.Events.FINISHED_LOADING ||
          (event.type === Blockly.Events.DELETE && workspace.getAllBlocks().length === 0))
        {
          addDefaultConnectionBlock();
        }

        // 更新撤销和重做按钮状态
        updateUndoRedoState();
      });

      // 添加撤销和重做按钮
      addUndoRedoButtons();
    });

    // 窗口大小变化时调整Blockly工作区
    function resizeBlocklyWorkspace()
    {
      // 在下一个事件循环中执行，确保DOM已更新
      setTimeout(function ()
      {
        if (workspace)
        {
          Blockly.svgResize(workspace);

          // 在调整工作区大小后重新定位撤销重做按钮
          repositionUndoRedoButtons();
        }
      }, 0);
    }

    // 定位撤销重做按钮的函数
    function repositionUndoRedoButtons()
    {
      const undoRedoControls = document.querySelector('.undoRedoControls');
      if (!undoRedoControls) return;

      // 获取放大缩小按钮容器
      const zoomControls = document.querySelector('.blocklyZoom');

      if (zoomControls)
      {
        const zoomRect = zoomControls.getBoundingClientRect();

        // 将撤销重做按钮与缩放控件在同一条竖线上
        undoRedoControls.style.right = (window.innerWidth - zoomRect.right) + 'px'; // 与放大缩小按钮右对齐
        undoRedoControls.style.top = (zoomRect.top - 70) + 'px'; // 放在放大缩小按钮上方
      }
    }

    // 添加默认的connect with IP积木块
    function addDefaultConnectionBlock()
    {
      // 只有当工作区为空时才添加默认积木
      if (workspace.getAllBlocks().length === 0)
      {
        // 创建make_connection积木块
        var connectionBlock = workspace.newBlock('make_connection');
        // 设置默认IP地址
        connectionBlock.setFieldValue('192.168.4.1', 'IP_ADDRESS');
        // 初始化积木块(确保所有连接点正确设置)
        connectionBlock.initSvg();
        // 渲染积木块
        connectionBlock.render();
        // 将积木块移动到合适的位置
        connectionBlock.moveBy(50, 50);
      }
    }

    // 添加清空工作区的函数
    function clearWorkspace()
    {
      workspace.clear();
      // 清空后自动添加默认连接积木
      addDefaultConnectionBlock();
    }

    function showCode()
    {
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      var code = Blockly.JavaScript.workspaceToCode(workspace);

      // 创建蒙版背景
      var overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
      overlay.style.zIndex = '999';
      overlay.style.display = 'flex';
      overlay.style.justifyContent = 'center';
      overlay.style.alignItems = 'center';

      // 点击蒙版时关闭对话框
      overlay.addEventListener('click', function (event)
      {
        if (event.target === overlay)
        {
          document.body.removeChild(overlay);
        }
      });

      // 创建一个包含代码的对话框
      var codeDialog = document.createElement('div');
      codeDialog.className = 'code-dialog';
      codeDialog.style.position = 'relative';
      codeDialog.style.backgroundColor = '#282c34';
      codeDialog.style.color = '#abb2bf';
      codeDialog.style.padding = '20px';
      codeDialog.style.borderRadius = '8px';
      codeDialog.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.5)';
      codeDialog.style.zIndex = '1000';
      codeDialog.style.maxWidth = '90%';
      codeDialog.style.maxHeight = '80%';
      codeDialog.style.overflow = 'auto';
      codeDialog.style.fontFamily = '"Consolas", "Monaco", monospace';

      // 标题
      var titleBar = document.createElement('div');
      titleBar.style.display = 'flex';
      titleBar.style.justifyContent = 'space-between';
      titleBar.style.alignItems = 'center';
      titleBar.style.marginBottom = '15px';

      var title = document.createElement('h3');
      title.textContent = '生成的JavaScript代码';
      title.style.margin = '0';
      title.style.color = '#e6e6e6';

      var closeButton = document.createElement('button');
      closeButton.textContent = '×';
      closeButton.style.background = 'none';
      closeButton.style.border = 'none';
      closeButton.style.color = '#e6e6e6';
      closeButton.style.fontSize = '24px';
      closeButton.style.cursor = 'pointer';
      closeButton.onclick = function ()
      {
        document.body.removeChild(overlay);
      };

      titleBar.appendChild(title);
      titleBar.appendChild(closeButton);
      codeDialog.appendChild(titleBar);

      // 格式化代码
      // 1. 分割每行
      var codeLines = code.split('\n');

      // 2. 创建代码显示区域
      var codeContainer = document.createElement('pre');
      codeContainer.style.margin = '0';
      codeContainer.style.overflow = 'auto';
      codeContainer.style.backgroundColor = '#282c34';
      codeContainer.style.padding = '10px';
      codeContainer.style.borderRadius = '4px';
      codeContainer.style.lineHeight = '1.5';
      codeContainer.style.maxHeight = '60vh';
      codeContainer.style.fontSize = '14px';
      codeContainer.style.color = '#e6e6e6'; // 设置代码文本颜色

      // 添加自定义滚动条样式
      codeContainer.style.scrollbarWidth = 'thin';
      codeContainer.style.scrollbarColor = '#4d4d4d #282c34';

      // 添加整个代码块的文本，而不是逐行添加
      codeContainer.textContent = code;

      codeDialog.appendChild(codeContainer);

      // 添加复制按钮
      var copyButton = document.createElement('button');
      copyButton.textContent = '复制代码';
      copyButton.style.marginTop = '15px';
      copyButton.style.padding = '6px 12px';
      copyButton.style.backgroundColor = '#4d78cc';
      copyButton.style.color = 'white';
      copyButton.style.border = 'none';
      copyButton.style.borderRadius = '4px';
      copyButton.style.cursor = 'pointer';
      copyButton.onclick = function ()
      {
        navigator.clipboard.writeText(code).then(function ()
        {
          copyButton.textContent = '复制成功！';
          setTimeout(function ()
          {
            copyButton.textContent = '复制代码';
          }, 2000);
        });
      };

      codeDialog.appendChild(copyButton);
      overlay.appendChild(codeDialog);
      document.body.appendChild(overlay);

      // 添加ESC键监听
      function handleEscKey(event)
      {
        if (event.key === 'Escape')
        {
          document.body.removeChild(overlay);
          document.removeEventListener('keydown', handleEscKey);
        }
      }
      document.addEventListener('keydown', handleEscKey);
    }

    function runCode()
    {
      window.LoopTrap = 1000;
      Blockly.JavaScript.INFINITE_LOOP_TRAP =
        'if (--window.LoopTrap < 0) throw "无限循环";\n';
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;

      // 添加辅助函数确保异步操作按顺序执行
      const asyncHelper = `
          // 辅助函数，确保异步打印能够立即执行
          function asyncLog(message) {
            return new Promise((resolve) => {
              console.log(message);
              // 强制浏览器更新DOM
              setTimeout(resolve, 0);
            });
          }

        // HTTP请求函数 - 发送命令到设备 (同步版本)
        function httpRequest(ip, command, returnResult = false) {
          console.log("发送命令: " + command);
          const url = \`http://\${ip}/?cmd=\${encodeURIComponent(command)}\`;
          
          try {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url, false); // false表示同步请求
            xhr.withCredentials = false;
            xhr.send();
            
            if (xhr.status === 200) {
              const result = xhr.responseText.trim();
              // 移除结果日志输出
              // console.log("命令执行成功，返回: " + result);
              
              if (returnResult) {
                // 检查命令是否为读取模拟、数字输入或传感器的命令
                const isReadCommand = command.startsWith("Ra") || 
                                     command.startsWith("Rd") || 
                                     command.startsWith("i ") ||
                                     command.includes(" ?");
                
                if (isReadCommand) {
                  // 从结果中提取等号后面的数字
                  const match = result.match(/=\s*(-?\d+)/);
                  if (match && match[1]) {
                    return match[1]; // 返回等号后的数字（字符串格式）
                  }
                }
                return result; // 对于其他命令或未找到匹配，返回原始结果
              }
              return true;
            } else {
              throw new Error(\`HTTP错误: \${xhr.status}\`);
            }
          } catch (error) {
            console.error("命令执行失败:", error.message);
            if (returnResult) {
              return "";
            }
            return false;
          }
          }
        `;

      // 将普通的console.log替换为使用asyncLog的形式
      code = code.replace(/console\.log\((.*?)\);/g, 'await asyncLog($1);');

      // 包装整个代码到一个异步函数中
      code = asyncHelper + "\n(async function() {\n" + code + "\n})().catch(e => alert(e));";

      try
      {
        eval(code);
      } catch (e)
      {
        alert(e);
      }
    }

    function saveWorkspace()
    {
      // 显示保存对话框，提供保存和另存为选项
      promptSaveOptions();
    }

    function promptSaveOptions()
    {
      // 创建蒙版背景
      var overlay = document.createElement('div');
      overlay.className = 'overlay';

      // 创建对话框
      var dialog = document.createElement('div');
      dialog.className = 'wifi-dialog';
      dialog.style.maxWidth = '400px';

      // 根据当前语言选择文本
      const title = currentLang === 'zh' ? '保存程序' : 'Save Program';
      let message = '';

      if (currentFile)
      {
        message = currentLang === 'zh' ?
          `当前文件: "${currentFile.name}"` :
          `Current file: "${currentFile.name}"`;
      } else
      {
        message = currentLang === 'zh' ?
          '尚未保存文件' :
          'No file saved yet';
      }

      const saveText = currentLang === 'zh' ? '保存' : 'Save';
      const saveAsText = currentLang === 'zh' ? '另存为' : 'Save As';
      const cancelText = currentLang === 'zh' ? '取消' : 'Cancel';

      const warningText = currentLang === 'zh' ?
        '注意：如果下载文件夹中已有同名文件，浏览器会自动添加数字后缀。' :
        'Note: If a file with the same name exists, the browser will add a number suffix.';

      dialog.innerHTML = `
        <h3>${title}</h3>
        <p>${message}</p>
        <p style="color: #999; font-size: 12px;">${warningText}</p>
        <div style="text-align: center; margin: 20px 0;">
          ${currentFile ?
          `<button onclick="saveFile('${currentFile.name}'); closeSaveOptionsDialog();" class="confirm" style="margin-right: 10px;">
              ${saveText}
            </button>` : ''}
          <button onclick="saveFileWithPrompt(); closeSaveOptionsDialog();" class="confirm" style="margin-right: 10px;">
            ${saveAsText}
          </button>
          <button onclick="closeSaveOptionsDialog()" class="cancel">
            ${cancelText}
          </button>
        </div>
      `;

      document.body.appendChild(overlay);
      document.body.appendChild(dialog);
    }

    function closeSaveOptionsDialog()
    {
      const dialog = document.querySelector('.wifi-dialog');
      const overlay = document.querySelector('.overlay');
      if (dialog) dialog.remove();
      if (overlay) overlay.remove();
    }

    function saveFile(filename)
    {
      var json = Blockly.serialization.workspaces.save(workspace);
      var blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });

      var a = document.createElement('a');
      a.download = filename;
      a.href = URL.createObjectURL(blob);
      a.click();

      // 显示保存成功消息
      showSaveSuccessDialog(filename);
    }

    function saveFileWithPrompt()
    {
      // 显示默认文件名
      let defaultName = 'program.json';
      if (currentFile)
      {
        defaultName = currentFile.name;
      }

      // 提示用户输入文件名
      const fileName = prompt(
        currentLang === 'zh' ? '请输入文件名:' : 'Enter file name:',
        defaultName
      );

      if (fileName)
      {
        // 添加.json扩展名（如果用户没有输入）
        let finalName = fileName;
        if (!finalName.toLowerCase().endsWith('.json'))
        {
          finalName += '.json';
        }

        // 保存文件
        saveFile(finalName);

        // 更新当前文件名
        currentFile = {
          name: finalName,
          lastModified: new Date().getTime()
        };

        // 更新显示的文件名
        const fileNameText = currentLang === 'zh' ?
          `当前文件: ${finalName}` :
          `Current file: ${finalName}`;

        document.getElementById('currentFileName').textContent = fileNameText;
      }
    }

    function showSaveSuccessDialog(fileName)
    {
      // 创建蒙版背景
      var overlay = document.createElement('div');
      overlay.className = 'overlay';

      // 创建对话框
      var dialog = document.createElement('div');
      dialog.className = 'wifi-dialog';
      dialog.style.maxWidth = '450px';

      // 根据当前语言选择文本
      const title = currentLang === 'zh' ? '保存成功' : 'Save Successful';
      const message = currentLang === 'zh' ?
        `文件已保存到您的"下载"文件夹。` :
        `File has been saved to your Downloads folder.`;

      const fileNameNote = currentLang === 'zh' ?
        `文件名: "${fileName}" (如下载文件夹中已有同名文件，浏览器可能自动添加数字后缀)` :
        `Filename: "${fileName}" (If a file with the same name exists, the browser may add a number suffix)`;

      const closeText = currentLang === 'zh' ? '关闭' : 'Close';

      dialog.innerHTML = `
        <h3 style="color: #4CAF50;">${title}</h3>
        <p>${message}</p>
        <p style="margin-top: 10px; font-size: 14px;">${fileNameNote}</p>
        <div style="text-align: center; margin: 20px 0;">
          <button onclick="closeSuccessDialog()" class="confirm">
            ${closeText}
          </button>
        </div>
      `;

      document.body.appendChild(overlay);
      document.body.appendChild(dialog);
    }

    function closeSuccessDialog()
    {
      const dialog = document.querySelector('.wifi-dialog');
      const overlay = document.querySelector('.overlay');
      if (dialog) dialog.remove();
      if (overlay) overlay.remove();
    }

    function loadWorkspace(file)
    {
      var reader = new FileReader();
      reader.onload = function (e)
      {
        try
        {
          var json = JSON.parse(e.target.result);
          Blockly.serialization.workspaces.load(json, workspace);

          // 保存当前文件信息
          currentFile = file;

          // 显示当前文件名
          const fileNameText = currentLang === 'zh' ?
            `当前文件: ${file.name}` :
            `Current file: ${file.name}`;
          document.getElementById('currentFileName').textContent = fileNameText;

          // 成功消息
          const successMsg = currentLang === 'zh' ?
            `成功加载: ${file.name}` :
            `Loaded: ${file.name}`;
          console.log(successMsg);
        } catch (err)
        {
          alert('无法载入文件: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    document.addEventListener('keydown', function (event)
    {
      if ((event.ctrlKey || event.metaKey) && event.key === 's')
      {
        event.preventDefault();
        saveWorkspace();
      }
      if ((event.ctrlKey || event.metaKey) && event.key === 'o')
      {
        event.preventDefault();
        document.getElementById('loadInput').click();
      }
      // 添加撤销快捷键(Ctrl+Z)
      if ((event.ctrlKey || event.metaKey) && !event.shiftKey && event.key.toLowerCase() === 'z')
      {
        event.preventDefault();
        // 使用undoStack_属性检查是否可以撤销
        if (workspace.undoStack_ && workspace.undoStack_.length > 0)
        {
          workspace.undo(false);
          updateUndoRedoState();
        }
      }
      // 添加重做快捷键(Ctrl+Y 或 Ctrl+Shift+Z)
      if ((event.ctrlKey || event.metaKey) &&
        ((event.key.toLowerCase() === 'y') ||
          (event.shiftKey && event.key.toLowerCase() === 'z')))
      {
        event.preventDefault();
        // 使用redoStack_属性检查是否可以重做
        if (workspace.redoStack_ && workspace.redoStack_.length > 0)
        {
          workspace.undo(true);
          updateUndoRedoState();
        }
      }
    });

    function addConsoleMessage(args)
    {
      const logDiv = document.getElementById('consoleLog');
      const time = new Date().toLocaleTimeString();

      const messageDiv = document.createElement('div');
      messageDiv.className = 'console-item';

      // 处理不同类型的参数
      const messages = Array.from(args).map(arg =>
      {
        if (typeof arg === 'object')
        {
          try
          {
            return JSON.stringify(arg, null, 2);
          } catch (e)
          {
            return String(arg);
          }
        }
        return String(arg);
      });

      messageDiv.textContent = `[${time}] ${messages.join(' ')}`;

      // 使用原生DOM方法确保立即渲染，改为添加到末尾
      logDiv.appendChild(messageDiv);

      // 保持最多显示100条记录
      while (logDiv.children.length > 100)
      {
        logDiv.removeChild(logDiv.firstChild);
      }

      // 立即设置滚动位置到底部，确保最新消息可见
      const consoleWindow = document.getElementById('consoleWindow');
      consoleWindow.scrollTop = consoleWindow.scrollHeight;

      // 强制DOM重绘，确保视图更新
      void consoleWindow.offsetHeight;
    }

    function clearConsole()
    {
      document.getElementById('consoleLog').innerHTML = '';
    }

    // 只重写 console.log
    const originalLog = console.log;
    console.log = function ()
    {
      addConsoleMessage(arguments);
      originalLog.apply(console, arguments);
    };

    // 添加串口通信相关的JavaScript代码
    let port = null;
    let reader = null;
    let writer = null;

    // 添加文件相关变量
    let currentFile = null;
    let currentFilePath = '';

    async function openSerialPort()
    {
      try
      {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        document.getElementById('serialInterface').style.display = 'block';
        document.getElementById('quickConnectBtn').disabled = false;
        document.getElementById('closeSerialBtn').disabled = false;

        // 设置读取器
        reader = port.readable.getReader();
        readSerialData();

        // 设置写入器
        writer = port.writable.getWriter();

      } catch (error)
      {
        console.error(getText("serialConnectionError"), error);
      }
    }

    async function closeSerialPort()
    {
      try
      {
        if (reader)
        {
          await reader.cancel();
          reader = null;
        }
        if (writer)
        {
          await writer.close();
          writer = null;
        }
        if (port)
        {
          await port.close();
          port = null;
        }

        document.getElementById('serialInterface').style.display = 'none';
        document.getElementById('quickConnectBtn').disabled = true;
        document.getElementById('closeSerialBtn').disabled = true;
        document.getElementById('ipDisplay').textContent = '';
      } catch (error)
      {
        console.error('关闭串口错误:', error);
      }
    }

    async function quickConnect()
    {
      // 创建遮罩层
      const overlay = document.createElement('div');
      overlay.className = 'overlay';
      document.body.appendChild(overlay);

      // 创建对话框
      const dialog = document.createElement('div');
      dialog.className = 'wifi-dialog';
      dialog.innerHTML = `
          <h3>${getText("wifiConfig")}</h3>
          <input type="text" id="ssidInput" placeholder="${getText("ssidPlaceholder")}">
          <input type="password" id="passwordInput" placeholder="${getText("passwordPlaceholder")}">
          <div class="button-container">
            <button class="cancel" onclick="closeWifiDialog()">${getText("cancel")}</button>
            <button class="confirm" onclick="confirmWifiSettings()">${getText("confirm")}</button>
          </div>
        `;
      document.body.appendChild(dialog);
    }

    function closeWifiDialog()
    {
      const dialog = document.querySelector('.wifi-dialog');
      const overlay = document.querySelector('.overlay');
      if (dialog) dialog.remove();
      if (overlay) overlay.remove();
    }

    async function confirmWifiSettings()
    {
      const ssid = document.getElementById('ssidInput').value.trim();
      const password = document.getElementById('passwordInput').value.trim();

      if (!ssid)
      {
        alert(getText("enterWifiName"));
        return;
      }

      const command = `w%${ssid}%${password}\n`;

      try
      {
        await writer.write(new TextEncoder().encode(command));
        closeWifiDialog();
      } catch (error)
      {
        console.error(getText("wifiCommandError"), error);
        alert(getText("wifiCommandFailed"));
      }
    }

    let ipCheckInterval = null;
    let serialBuffer = '';

    async function readSerialData()
    {
      try
      {
        while (true)
        {
          const { value, done } = await reader.read();
          if (done)
          {
            reader.releaseLock();
            break;
          }
          const text = new TextDecoder().decode(value);
          serialBuffer += text;

          // 检查是否包含IP地址信息
          const ipMatch = serialBuffer.match(/IP Address: ([0-9.]+)/);
          if (ipMatch)
          {
            const ip = ipMatch[1];
            document.getElementById('ipDisplay').textContent = `${getText("serialConfiguredIP")}${ip}`;
            serialBuffer = '';  // 清空缓冲区
          }

          // 更新输出显示，确保每条消息后面都有换行符
          const outputDiv = document.getElementById('serialOutput');
          outputDiv.innerHTML += text.replace(/\n/g, '<br>');  // 将\n替换为<br>
          outputDiv.scrollTop = outputDiv.scrollHeight;
        }
      } catch (error)
      {
        console.error(getText("serialReadError"), error);
      }
    }

    async function sendSerialData()
    {
      if (!writer) return;

      const input = document.getElementById('serialInput');
      const data = input.value + '\n';

      try
      {
        await writer.write(new TextEncoder().encode(data));
        input.value = '';
      } catch (error)
      {
        console.error(getText("serialSendError"), error);
      }
    }

    function clearSerialOutput()
    {
      const outputDiv = document.getElementById('serialOutput');
      outputDiv.innerHTML = '';
    }

    // 添加回车键发送功能
    document.getElementById('serialInput').addEventListener('keypress', function (e)
    {
      if (e.key === 'Enter')
      {
        sendSerialData();
      }
    });

    // 添加撤销和重做按钮
    function addUndoRedoButtons()
    {
      // 检查是否已存在按钮，如果存在则移除
      const existingControls = document.querySelector('.undoRedoControls');
      if (existingControls)
      {
        existingControls.remove();
      }

      // 创建包含按钮的div
      const undoRedoControls = document.createElement('div');
      undoRedoControls.className = 'undoRedoControls';

      // 创建撤销按钮
      const undoButton = document.createElement('button');
      undoButton.className = 'undoRedoButton';
      undoButton.id = 'undoButton';
      undoButton.title = currentLang === 'zh' ? '撤销' : 'Undo';
      undoButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 14L4 9l5-5"/>
          <path d="M4 9h13c2.5 0 4 2 4 4s-1.5 4-4 4H8"/>
        </svg>
      `;
      undoButton.onclick = function ()
      {
        if (workspace.undoStack_ && workspace.undoStack_.length > 0)
        {
          workspace.undo(false);
          updateUndoRedoState();
        }
      };

      // 创建重做按钮
      const redoButton = document.createElement('button');
      redoButton.className = 'undoRedoButton';
      redoButton.id = 'redoButton';
      redoButton.title = currentLang === 'zh' ? '重做' : 'Redo';
      redoButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 14l5-5-5-5"/>
          <path d="M20 9H7c-2.5 0-4 2-4 4s1.5 4 4 4h9"/>
        </svg>
      `;
      redoButton.onclick = function ()
      {
        if (workspace.redoStack_ && workspace.redoStack_.length > 0)
        {
          workspace.undo(true);
          updateUndoRedoState();
        }
      };

      // 将按钮添加到控件容器
      undoRedoControls.appendChild(undoButton);
      undoRedoControls.appendChild(redoButton);

      // 将控件容器添加到body
      document.body.appendChild(undoRedoControls);

      // 确保按钮是可见的
      undoRedoControls.style.display = 'flex';

      // 尝试初次定位按钮
      repositionUndoRedoButtons();

      // 再尝试几次定位，确保即使DOM渲染有延迟也能正确显示
      setTimeout(repositionUndoRedoButtons, 500);
      setTimeout(repositionUndoRedoButtons, 1000);

      // 初始化按钮状态
      updateUndoRedoState();
    }

    // 更新撤销和重做按钮状态
    function updateUndoRedoState()
    {
      const undoButton = document.getElementById('undoButton');
      const redoButton = document.getElementById('redoButton');

      if (undoButton && redoButton)
      {
        // 修复hasUndo和hasRedo方法调用，改用undoStack_和redoStack_属性判断
        const canUndo = workspace.undoStack_ && workspace.undoStack_.length > 0;
        const canRedo = workspace.redoStack_ && workspace.redoStack_.length > 0;

        undoButton.disabled = !canUndo;
        redoButton.disabled = !canRedo;

        // 更新按钮标题语言
        undoButton.title = currentLang === 'zh' ? '撤销' : 'Undo';
        redoButton.title = currentLang === 'zh' ? '重做' : 'Redo';
      }
    }
  </script>
</body>

</html>
